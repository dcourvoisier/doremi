---
title: "second-order"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{second-order}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(doremi)
library(ggplot2)
library(data.table)
library(magrittr)
library(deSolve)
set.seed(1)
```

# SECOND ORDER DIFFERENTIAL EQUATION MODELS WITHOUT AN EXCITATION TERM

This is the configuration will deal with first, as many studies in the literature use the Damped Linear Oscillator (DLO) in which there aren't any external excitation terms driving the dynamics.This model is described by the equation:
$$\frac{d^2y}{dt} + 2\xi\omega_{n}\frac{dy}{dt} + \omega_{n}^2 (y-y_{eq}) = k*u(t)$$ 
(1)

In which the term $u(t)=0$ thus leading to the equation:
$$y'' + 2\xi\omega_{n}y' + \omega_{n}^2 (y-y_{eq}) = 0$$ 
(2)

Where:

* $\omega_{n} = \frac{2\pi}{T}$ -where T is the period of the oscillation- is the system's natural frequency, the frequency with which the system would vibrate if there were no damping.The term $\omega_{n}^2$ represents thus the ratio between the attraction to the equilibrium and the inertia. If we considered the example of a mass attached to a spring, this term would represent the ratio of the spring constant and the object's mass.

* $\xi$ is the damping ratio. It represents the friction that damps the oscillation of the system (slows the rate of change of the variable). The term $2\xi\omega_{n}$ thus represents the respective contribution of the inertia, the friction and the attraction to the equilibrium.

Equation (2) can also be found in the social/behavioral sciences literature as:
$$y'' + \zeta y' + \eta y = 0$$
(3)
That assumes the $y_{eq}$ is 0.

In which: 
$$\zeta= 2\xi\omega_{n}$$
and 
$$\eta=\omega_{n}^2$$
(4)

The dynamics in this case are then provoked either by a previous excitation that is no longer present or by the displacement of the system from its equilibrium position (either due to an initial condition different from 0 or an initial "speed" or derivative at time 0 different from 0):
$$y(t=0)=y_{0}$$
$$\frac{dy}{dt}(t=0)=v_{0}$$
The shape of the solution to equation (2) -also called trajectory, or system response in engineering- will change according to the values of the parameters $\xi$ and $\omega_{n}^2$ presented, specially the values of $\xi$, as this parameter will define if the behavior is divergent, oscillating or undamped, underdamped (oscillations decreasing exponentially) or overdamped (system going back to equilibrium without oscillations) as it can be seen in the figure below:

```{r fig.width = 5, fig.height = 4, fig.align = "center"}
data11a <- rbindlist(lapply(seq(0,2,0.2), function(eps){
  generate.2order(time = 0:49, y0 = 1, xi = eps, period = 30)[,xi := eps][]
}))
# plot
ggplot2::ggplot(data11a,ggplot2::aes(t,y,color = as.factor(xi)))+
  ggplot2::geom_line() +
  ggplot2::labs(x = "time (arb. unit)", y = "signal (arb. unit)", colour = "xi")
```

## Simulating data

### Example 11 - Generating Damped Linear Oscillator signals with inter-individual variability

```{r}
time <- 0:100
data11b <- generate.panel.2order(time = time,
                               y0 = 10,
                               v0 = 0,
                               xi = 0.1,
                               period = 30,
                               k = 1,
                               yeq = 2,
                               nind = 6,
                               internoise = 0.3,
                               intranoise = 5)
```

When there is no excitation, either the input can be set to NULL or not even set at all, like in the example.
```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(data11b) +
  ggplot2::geom_hline(yintercept=0)
```  

## Analyzing data

### Example 12 - Analyzing Damped Linear Oscillator signals

Analyzing the previous dataset and as for the first order model, the user must specify the name of the columns containing the id of the participants, the excitation, and the signal. Once again, several methods are available for the estimation of the derivatives and the user needs to specify which method to use (\code{gold} is the default) and the embedding dimension/smoothing parameter (see the package pdf manual for more details).

```{r}
res12 <- analyze.2order(data = data11b,
                        id = "id",
                        time ="time",
                        signal = "signal",
                        dermethod = "glla",
                        derparam = 9,
                        order = 4)
```

Now letâ€™s take a look at the result. When calling the variable, the mean three coefficients of the differential equation found and the R2 are displayed:
  
```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(res12)
```

And the different parts of the resulting doremi object are the same as those for the first order:

* data: contains the original dataset and extra columns for intermediate calculations. The column "signalname_derivate2" is the only one additional with respect to the first order result.

* resultid: contains the coefficients fit for each individual. In the figure above it can be seen that for some of them, the fit wasn't very good. This will be enhanced through the use of the function "optimum_param" that will identify which embedding number produces the maximum R2, as for the first order case. For each individual we then have:
  
```{r}
res12$resultid
```
Beware that, as known in the two-steps procedures, and as in the firstorder case, the estimation of derivatives is a source of vias and thus the error terms provided by the regression are not final. Nevertheless, it is possible to obtain from the summary of the regression the standard errors calculated for the coefficients estimated that will be \zeta, \eta (see equations 3 and 4) and $y_{eq}*w_n^2$ if the equilibrium value is different from 0.

In the resultid object, the first three columns are the terms resulting from the regression:

  * omega2 is the term $\omega_n^2$ or $\eta$

  * esp2omega is the term $2\xi \omega_n^2$ or $\zeta$

  * yeqomega2 is $y_{eq}\omega_n^2$, the regression intercept, from which the equilibrium value can be extracted

Whereas the following are the values calculated from these first columns:

  * period is the oscillation period, that can be extracted from the term $\omega_n^2$, were $T=2\pi/\omega_n$

  * wn is the natural frequency, calculated also from the term $\omega_n^2$

  * xi is the damping factor, calculated from the term $2\xi \omega_n^2$

  * yeq is the equilibrium value, calculated from $y_{eq}\omega_n^2$

  * komega2 is the coefficient associated to the external excitation term in the regression. As there is no excitation on this example, it is 0.


* resultmean: contains the fixed coefficients resulting from the regression for all the individuals. It is also what is shown when one calls the variable name:

```{r}
res12
```

* regression: contains the summary of the multilevel regression carried out to fit the coefficients

The doremi object will also contain the derivative method used and the embedding number/smoothing parameter used for further reference.

# SECOND ORDER DIFFERENTIAL EQUATION MODELS WITH AN EXCITATION TERM

## Simulating data 

### Example 13 - Generating signals with no noise

In this example we will generate data for 5 individuals, that respond to a "step" excitation (an excitation that changes value abruptly, from 0 to 1 in this case). We will consider no dynamic noise, no variation of the damping factor, period or equilibrium value across individuals (no interindividual noise). 
```{r}
time <- 0:100
data13 <- generate.panel.2order(time = time,
                               excitation = as.numeric(time>20),
                               y0 = 0,
                               v0 = 0,
                               xi = 0.1,
                               period = 30,
                               k = 1,
                               yeq = 0,
                               nind = 5,
                               internoise = 0,
                               intranoise = 0)
```

Plotting once more the data with the plot method available in the package for doremidata objects:
```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(data13)
```  

### Example 14 - Generating signals with noise
The call to the function remains almost the same, this time with a signal to noise ratio (STN) of 1/0.2=5 and a 30% inter-individual noise:

```{r}
# Generation of signals with intra and inter-noise
time <- 0:100
data14 <- generate.panel.2order(time = time,
                               excitation = as.numeric(time>20),
                               y0 = 0,
                               v0 = 0,
                               xi = 0.1,
                               period = 30,
                               k = 1,
                               yeq = 0,
                               nind = 5,
                               internoise = 0.3,
                               intranoise = 5)
```

```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(data14)
```
And, as it can be seen in the figures, the coefficients change according to the person (damping factor, period, gain). Initial value, speed and equilibrium value could also change if their initial value was different from 0.These have been set to 0 for readibility of the results but they could also be included, as it was the case in example 11b

### Example 15 - studying the effect of periodical excitations

This package can be used to simulate driven damped oscillators and to learn the effect that type of excitation can have in the dynamics of the system studied:
```{r}
t <-0:99
xi <- 0.2
period <- 30
dlo <- generate.2order(time = t,y0 = 1, xi = xi, period = period)
driven_dlo <- generate.2order(time = t, excitation = 5*sin(t), y0 = 1, xi = xi, period = period)
```

```{r fig.width = 5, fig.height = 4, fig.align = "center"}
ggplot2::ggplot() + 
  ggplot2::geom_point(data=dlo,ggplot2::aes(t,y,color="dlo")) + 
  ggplot2::geom_line(data=driven_dlo,ggplot2::aes(t,y,color="driven dlo"))
```


## Analyzing data

Analyzing the signals with noise generated above, we can verify that the parameters were the one introduced in the simulation function and that the estimated signals generated match the simulated oneS.

### Example 16 - Analyzing data with several individuals and some inter and intra-individual noise

Analyzing the data generated in the example 2 above, the user must specify the name of the columns containing the id of the participants, the excitation, and the signal.
AS several methods are available for the estimation of the derivatives, the user needs to specify which method to use (\code{gold} is the default) and the embedding dimension (see the package pdf manual for more details).

```{r}
res16 <- analyze.2order(data = data14,
                        id = "id",
                        input ="excitation",
                        time ="time",
                        signal = "signal",
                        dermethod = "gold",
                        derparam = 5,
                        order = 4)
```


```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(res16)
```

### Example 17 - Enhancing the fit by changing the embedding number/ smoothing parameter.

As it was mentioned before, the estimation of derivatives is a source of vias. It is possible to enhance the quality of the fit in three ways:

* By changing the embedding number/smoothing parameter

* By changing the order of the derivative

* By changing the derivation method

In the following example, we will use the function `optimum_param` to find the embedding number that provides an R2 the closest to 1. The other ways can be tested "manually" by calling the other functions, for instance, in a simulation study.

```{r}
res17<-optimum_param (data=data14,
                      id="id",
                      input="excitation",
                      time="time",
                      signal="signal",
                      model = "2order",
                      dermethod = "glla",
                      order = 2,
                      pmin = 5,
                      pmax = 17,
                      pstep = 2)
res17$analysis
res17$summary_opt
res17$d
```

And it can be seen that, from the range provided, an embedding number of 13 produces the best fit and that the coefficients are closer to their true values than the ones estimated in the previous example.

If we want to graphically see the evolution of the coefficients according to the embedding number in this case, we can easily plot the results with the `plot` function. This will call the method for the plotting of "doremiparam" objects:

```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(res17)
```
And doing again the analysis with the optimum embedding number:
```{r}
res18 <- analyze.2order(data = data14,
                        id = "id",
                        input ="excitation",
                        time ="time",
                        signal = "signal",
                        dermethod = "glla",
                        derparam = 13,
                        order = 2)
res18
```


```{r fig.width = 7, fig.height = 6, fig.align = "center"}
plot(res18)
```

### Example 19 - Analyzing data when the signal is subject to several excitations and no noise

In this example, the signal for each individual is set to depend on a linear combination of three excitation signals: 

$$u(t)=a*u_{1}(t)+b*u_{2}(t)+c*u_{3}(t)$$

```{r}
#Simulating data with these hypothesis
#Generating the three excitation signals:
u1 <- generate.excitation (amplitude = 10, 
                           nexc = 1, 
                           duration = 10, 
                           deltatf = 1, 
                           tmax = 100,
                           minspacing = 20)
u2 <- generate.excitation (amplitude = 10, 
                           nexc = 1, 
                           duration = 10, 
                           deltatf = 1, 
                           tmax = 100,
                           minspacing = 20)
u3 <- generate.excitation (amplitude = 10, 
                           nexc = 1, 
                           duration = 10, 
                           deltatf = 1, 
                            tmax = 100,
                           minspacing = 20)
# Arbitrarily choosing a = 1, b = 2 and c = 5 for the first individual
et1 <- u1$exc + 3 * u2$exc + 5 * u3$exc
timt1 <- u3$t  #we can use any of the three time vectors as they are identical for the three excitations
y1 <- generate.2order(time = timt1,
                            excitation = et1)$y
#as we are using the $y argument of the object generated

#Signals for the second individual;
# Arbitrarily choosing a = 1, b = 2.5 and c = 4 for the second individual
et2 <- u1$exc + 2.5 * u2$exc + 4 * u3$exc
y2 <- generate.2order(time = timt1,
                            excitation = et2)$y 

#Generating table with signals
data19 <- data.frame(id = rep(c(1, 2), c(length(et1), length(et2))), 
                 time = c(timt1, timt1),
                 excitation1 = c(u1$exc, u1$exc),
                 excitation2 = c(u2$exc, u2$exc),
                 excitation3 = c(u3$exc, u3$exc),
                 excitation = c(et1, et2), 
                 signalcol = c(y1, y2))
```

```{r fig.width = 7, fig.height = 4, fig.align = "center"}
#Plotting signals
ggplot2::ggplot( data = data19) +
  ggplot2::geom_line(ggplot2::aes(time,signalcol, colour = "Signal-no noise"))+
  ggplot2::geom_line(ggplot2::aes(time,excitation,colour = "Total excitation"))+
  ggplot2::facet_wrap(~id)+
  ggplot2::labs(x = "Time (s)",
           y = "Signal (arb. unit)",
           colour = "")
```

```{r}
#Analyzing signals
res19 <- analyze.2order(data = data19,
                       id = "id",
                       input = c("excitation1", "excitation2", "excitation3"),
                       time = "time",
                       signal = "signalcol",
                       dermethod = "fda",
                       derparam = 0.1)

#Looking for the calculation of the coefficients of the excitation
res19
res19$resultid

```

And one can find the excitation coefficients estimated by extracting them from the `$resultid`. It can be seen that they are a good approximation of the coefficients introduced.

```{r fig.width = 7, fig.height = 4, fig.align = "center"}
#Plotting signals
plot(res19)
```

### Example 20 - Analyzing data from a single individual

The call to the function is almost the same, but omitting the `id` parameter in the call:

```{r}
#Analyzing
res20 <- analyze.2order(data = data14[id==1],
                      input = "excitation",
                      time ="time",
                      signal = "signal",
                      dermethod = "fda",
                      derparam = 0.8,
                      verbose=T)
```

```{r fig.width = 6, fig.height = 4, fig.pos = 0.5, fig.align = "center"}
plot(res20)
```

### Example 21 - Using an initial condition in a time different from t0=0

When analyzing the signals, there are already situations in which the time t0 used for the generation of the curves with deSolve, is not the first time value of the time vector, t0. This is because when using glla ou gold, the derivative is estimated in the time points of the embedding matrix, thus according to the embedding dimension set as input. This is to avoid the need of a starting value for the initial condition and the derivative at t=t0. These are taken from the first values of the signal rollmean and derivative estimated respectively, thus being a reasonably good guess. As that point is not t0, in order to generate the whole curve, it is taken as initial condition to generate the signal is then generated from that point to the right and, in the same way, to the left, with a time interval [tembed, t0] and then both solutions are binded together to build the final solution. Below there is an example of this by using the function generate.2order independently:
```{r}
time <- 0:99
data21_t0_0 <- generate.2order(time = time,
                               excitation = as.numeric(time>20),
                               y0 = 0,
                               v0 = 0,
                               t0 = 0,
                               exc0 = 0,
                               xi = 0.1,
                               period = 30,
                               k = 1,
                               yeq = 0)
data21_t0_0[t==43]
```
For instance, taking the signal value in t=43 as initial value: y=1.077549. The speed at that point is dy=-1.311226e-01	and the excitation, 1.Then the call to the function will be in this case:
```{r}
data21_t0_43 <- generate.2order(time = time,
                               excitation = as.numeric(time>20),
                               y0 = 1.077549,
                               v0 = -1.311226e-01,
                               t0 = 43,
                               exc0 = 1,
                               xi = 0.1,
                               period = 30,
                               k = 1)

```

```{r fig.width = 6, fig.height = 4, fig.pos = 0.5, fig.align = "center"}
ggplot2::ggplot() + 
  ggplot2::geom_line(data=data21_t0_0,ggplot2::aes(t,y,color="Solution with t0=0")) +
  ggplot2::geom_point(data=data21_t0_43,ggplot2::aes(t,y,color="Solution with t0=43"))
```

### Example 22 - Using simulation functions to generate undamped, critically damped and overdamped signals

Very often in the literature, we find the use of the Damped LInear Oscillator (DLO). But in most of the cases the only behavior considered is the underdamped, that is, when $0<\xi<1$, a system with oscillations exponentially decrasing until the system finds (or is closely around) the equilibrium value. However, there are cases in which the system reached its equilibrium value WITHOUT oscillations: these are the critically damped ($\xi=1$) and overdamped ($\xi>1$). The simulation functions of the package also allow the generation of these behaviors -and even undamped signals (purely oscillating)- with all the other features already explored (generation for several individuals, varying the coefficients between individuals, addition of dynamical noise), as it can be seen in the example below (where the excitation term has been set to 0 for readibility). 

```{r}
data22a <- generate.panel.2order(time = 0:99,
                               y0 = 1,
                               v0 = 0,
                               xi = 0,
                               period = 30,
                               k = 1,
                               yeq = 0,
                               nind = 1,
                               internoise = 0,
                               intranoise = 5)
data22b <- generate.panel.2order(time = 0:99,
                               y0 = 1,
                               v0 = 0,
                               xi = 1,
                               period = 30,
                               k = 1,
                               yeq = 0,
                               nind = 1,
                               internoise = 0,
                               intranoise = 5)
data22c <- generate.panel.2order(time = 0:99,
                               y0 = 1,
                               v0 = 0,
                               xi = 2,
                               period = 30,
                               k = 1,
                               yeq = 0,
                               nind = 1,
                               internoise = 0,
                               intranoise = 5)

```

```{r fig.width = 7, fig.height = 5, fig.align = "center"}
grid.arrange(plot(data22a)+ggplot2::ggtitle("undamped, xi=0"), plot(data22b)+ggplot2::ggtitle("critically damped, xi=1"), plot(data22c)+ggplot2::ggtitle("overdamped, xi=2"), ncol= 3)
```


